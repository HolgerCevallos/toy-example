# Toy Example: Distributional Shift and Jackknife Conformal Methods


## Overview

This repository reproduces a toy simulation illustrating two conformal prediction methods for functional data. Both approaches are combined with a robust PCA procedure (DsubLTS) for dimensionality reduction:

- Nonasymptotic Distributional Shift  
- Jackknife-based conformal prediction
------------------------------------------------------------------------

## Load Required Libraries

``` r
library(Rcpp)
library(RcppArmadillo)
library(robustbase)
library(mgcv)
library(EasyMMD)
```

## How to Run

1. Clone the repository:

git clone https://github.com/HolgerCevallos/toy-example.git

2. Open R or RStudio and set the working directory to the project folder.

3. Run the main script:

source("toy.example.R")
------------------------------------------------------------------------

# C++ Compilation

``` r
sourceCpp('src/MyPcs.cpp')
sourceCpp('src/MyPcs2.cpp')
sourceCpp('src/MyclassicalPcs.v2.cpp')
```

------------------------------------------------------------------------

# Load R Functions

``` r
source("R/DsubLTS.R")
source("R/NonasymptoticDistributionalShift.final.R")
source("R/Jackknife.calib.final.R")
source("R/Jackknife.pred.final.R")
```

------------------------------------------------------------------------

# Design 1

lambda.k1.values <- function(k){
  lambda.k1 <- 0.5^(k-1)
  return(lambda.k1)
}

lambda.l2.values <- function(l){
  lambda.l2 <- 0.5^(l-1)
  return(lambda.l2)
}

xik.values <- function(lambda.k1){
  xik <- rnorm(1,0,lambda.k1)
  return(xik)
}

zetaijl.values <- function(lambda.l2){
  zetaijl <- rnorm(1,0,lambda.l2)
  return(zetaijl)
}

phik1.values <- function(t){
  phik1 <- list(sqrt(2)*sin(2*pi*t),
                sqrt(2)*cos(2*pi*t),
                sqrt(2)*sin(4*pi*t),
                sqrt(2)*cos(4*pi*t))
  return(phik1)
}

phil2.values <- function(t){
  phil2 <- list(sqrt(2)*sin(6*pi*t),
                sqrt(2)*cos(6*pi*t),
                sqrt(2)*sin(8*pi*t),
                sqrt(2)*cos(8*pi*t))
  return(phil2)
}


# Data generation of calibration set

# Calibration set:
# 5 subjects, 50 curves are generated per subject at 21 time points

Npatients <- 5 #nÃºmero de pacientes
Yij.todos <- vector("list", Npatients) 

for (s in 1:Npatients){
  
  sigma <- 1
  Nt <- 21
  curves.per.patient <- 50
  fixed.subject.effect <- rep(0,Nt)
  visit.effect <- matrix(0, nrow=curves.per.patient, ncol=Nt)
  Yij <- matrix(0, nrow=curves.per.patient, ncol=Nt)
  tm <- (0:20)/100
  
  for(t in 1:Nt){
    for(k in 1:4){
      lambda.k1 <- lambda.k1.values(k)
      set.seed(123+40+s)
      fixed.xk <- xik.values(lambda.k1)
      fixed.subject.effect[t] <- fixed.subject.effect[t] + 
        fixed.xk*phik1.values(tm[t])[[k]]
    }
  }
  
  for(j in 1:curves.per.patient){
    for(t in 1:Nt){
      for(l in 1:4){
        lambda.l2 <- lambda.l2.values(l)
        set.seed(123+s+j)
        zetaijl <- zetaijl.values(lambda.l2)
        visit.effect[j,t] <- visit.effect[j,t] + 
          zetaijl*phil2.values(tm[t])[[l]]
      }
    }
  }
  
  for(j in 1:curves.per.patient){
    for(t in 1:Nt){
      Yij[j,t] <- fixed.subject.effect[t] + visit.effect[j,t] +
        rnorm(1,0,sigma)
    }
  }
  Yij.todos[[s]] <- Yij
}


------------------------------------------------------------------------

# Distributional Shift Method

``` r
fit.pooled.method <- DistributionalShift.fun(
  x = Yij.todos,
  mesh = tm,
  dimension.Bspline = 20,
  q = 2,
  indexTargetSubject = 1,
  alpha = 0.5
)
```

## Results

### Quantile
``` r
fit.pooled.method$quantile

[1] 0.731306
```

### Prediction Region Indices

``` r
fit.pooled.method$predictionRegionIndices

[1]  3  6 10 11 12 15 19 20 21 22 23 25 26 29 30 34 35 36 37 39 43 46 47 48 49 50
```

Total selected: **26 / 50**

### Prediction Region Curves

``` r
fit.pooled.method$predictionRegionCurves
             [,1]        [,2]         [,3]       [,4]        [,5]        [,6]        [,7]        [,8]        [,9]
 [1,] -0.06728279  0.42769636 -0.864567519 -2.1930013 -2.56341025 -1.52045246 -0.56735786 -0.54389089 -0.16961906
 [2,]  1.53988890  2.09687202  3.177553700  2.2276594  0.33240574  3.04085662  4.37333683  3.72619976  2.83332262
 [3,]  0.07498266 -1.85637438 -0.798370337 -0.4589230 -1.97081863  1.66571317 -2.50933766 -0.52693762 -1.79742202
 [4,] -0.48035943  0.17024230  0.002953131 -0.7472501 -1.74883488 -1.75991611  0.01809948 -1.16532719  0.17744711
 [5,] -0.24848285 -0.84585236 -0.720231285 -0.1414795  0.83718407  0.12900440 -0.73351332 -0.25039066 -0.54498263
 [6,] -0.79220610 -0.29278600  0.914155218  0.2536944 -1.61632203 -0.96033050 -0.06077084  0.02053263  1.59723633
 [7,]  1.22418164  1.76829468  1.526938351  1.1177550  2.57039205  1.69605662  3.24551953  4.21606900  1.77576011
 [8,] -0.95738870 -3.05189121 -0.238399410 -3.6037138 -2.91548472 -4.94151541 -2.25277128 -3.48458892 -1.83803095
 [9,]  1.01652625 -0.60800483 -0.347580825  0.9765726  2.57601551  2.54558901  0.17134630  0.68064030 -0.38933873
[10,] -1.33055006  1.60730596 -0.765286296 -0.8200357 -2.12506209  0.27391695 -2.85123116 -1.79804428 -1.03697222
[11,]  1.44620734 -2.01975741  0.149609499  1.8886158  2.04122581  2.32507778  0.77688055  0.60609735  1.81866005
[12,]  0.65911299  0.61158474  1.114033266  0.6572477  2.27609967  3.69631394  2.39581937  2.26615958  0.43770375
[13,] -1.39112593 -2.84542867 -2.011590360 -2.7580249 -4.01508321 -3.90766828 -4.52902746 -3.40372096 -1.26541767
[14,]  2.69560458  4.88032443  4.143939772  5.1207918  3.97526011  4.60623309  6.39417938  5.81370037  4.23848929
[15,] -0.21308887  1.10990720  2.460776363  0.2729872  1.25686059  1.08963602  0.86095264 -0.69734889  1.41990108
[16,]  1.54521637  1.17641172  2.041354763  2.4069938  1.60118450  2.91907999  1.73511738  1.42816710  0.54028857
[17,] -0.49919080 -1.71213589 -1.812796411 -2.1208959 -2.40773529 -2.35261124 -3.21750218 -1.76658166 -2.93208894
[18,]  1.99595501 -0.04700077 -0.020249296 -0.5092450  0.66468085  1.53653335  0.90865231  1.31066003  2.10011534
[19,]  0.01343214 -0.71173902 -1.649072316  1.1092790 -0.04472933  0.46654013 -1.86461766 -2.04037240 -0.83152067
[20,]  0.56225736 -0.06669530 -2.490558551 -0.7238872  0.81727903 -1.67343913 -0.30841145 -1.15804070  0.93029762
[21,] -1.16895327 -1.92511794 -2.438697620 -3.5719111 -1.88565536 -2.18501208 -2.63996698 -3.04516621 -3.89836251
[22,]  1.43714615  1.99154423  4.036244361  2.9127938  3.56322675  2.87529427  2.35012821  3.01864926  3.09038896
[23,] -0.60365996 -0.82591337 -1.741972408 -0.4034985 -2.16541220 -1.16947751 -1.90985937 -0.18176905 -1.17998625
[24,]  0.21796782 -0.54916477  0.910681137  0.5890195  0.41828093  0.03743514  0.37778164  0.51982868  0.09675941
[25,]  1.19239733  1.71811372  0.457489086  1.5142152  1.10396392  2.29399413  2.31090389  1.45683639  0.96683794
[26,]  2.32011148  0.83312231  1.775129659  2.9266467  2.24692507  2.66102639  2.97495635  2.06145831  2.36075427
           [,10]      [,11]      [,12]       [,13]      [,14]      [,15]       [,16]      [,17]      [,18]       [,19]
 [1,] -0.3533120 -0.3962315 -0.4464816 -0.86809697  0.9154530  0.2004448 -1.05473052  1.6331321  1.3257388  1.24040822
 [2,]  2.9046738  0.9892707  0.6163077 -0.48507547 -0.5207481 -2.4198491 -2.98247052 -1.5541787 -2.3259781 -2.75992474
 [3,] -1.1690932 -1.6749468 -0.9859953 -1.54759699 -0.2429304  1.1546085  0.53684199  0.3530543  2.0409950  0.94481342
 [4,] -1.2027682 -1.9729100 -0.5862977  0.95528750  1.0577468 -0.2624587  0.87105275  1.6194307 -1.0256820  1.05640864
 [5,] -0.7495569 -0.3774342 -0.9923288  0.79257406  1.0175289 -0.3087922  0.05156824  1.0273475  1.7251178  0.80773604
 [6,]  0.6444536 -0.1645622 -1.3885109 -0.40631243 -0.6856175  0.2086902 -0.12699828 -2.1656724  0.2306161  1.25605314
 [7,]  4.0025827  1.8354807  0.2031281  1.16753543 -0.3340063 -0.4942130  0.05769928 -2.3296549 -1.0907665 -3.25226144
 [8,] -2.1574219 -1.8131163 -1.2460281  0.57958486 -1.3695812 -2.0245562  1.77839707  2.1655309  2.1648418  2.09718156
 [9,] -0.7800664 -0.3231394  1.1456089  1.45055133  0.2422123 -0.3020188  0.34477448 -2.0320045  1.5208202 -1.80255851
[10,] -0.4442279 -1.0994115 -0.2762417 -1.32439352 -0.2442506  0.5360293  1.80405289  0.1498074  1.6455766  1.68878925
[11,]  0.4686831 -0.3952438  2.1025442 -0.56406102  0.8550608 -1.9111638 -0.44848288  0.5460397 -0.7882899 -0.84317300
[12,]  1.5214618  0.8630718 -0.1805424  1.06578757 -0.8321500 -1.5189003  0.36637897 -0.5084476 -0.5000396 -1.78205917
[13,] -2.6121618 -2.1744006 -2.2546591 -2.45471726  0.8875147  0.5794218  1.68673673  2.1164347  1.0002444  1.31144218
[14,]  3.9885136  2.0228873  3.7031311  1.83272948  0.3705545 -1.5263717 -1.67158274 -2.4866161 -2.8009543 -2.72551543
[15,]  0.7672960  1.0264124  0.6592237 -0.18745598 -0.2489907  0.9703839  0.99646061 -0.9111613 -0.2618302 -1.18469917
[16,]  3.0145593  0.2961238  0.0253070 -0.08702741  0.2725796  0.9851703  0.33503563 -1.8973605 -0.6297081 -1.19812434
[17,]  0.8225857 -1.2196791  0.0176566  0.17494482  0.4861408 -2.2242863  0.47708110  1.3503576  0.5489048  1.64761674
[18,]  2.0194780  0.3801560 -0.2966198  0.95538143  0.8949877 -1.2983645 -0.18332453  0.6223782 -0.3137400 -0.04152841
[19,]  0.6496536  0.3761575  0.8445758 -2.13694900 -0.1626001  1.3506702 -0.89158384  0.3835933 -0.7207772  0.40087152
[20,] -1.2550994 -0.3709532  1.6336193  0.66040847  0.6846359  1.2323277  1.52965995 -0.5916958 -1.2872887 -0.49264017
[21,]  0.2432655 -2.1408843 -0.2145197  2.14288773 -0.1065432  0.8859456  2.45222339  1.6782789  1.3171244  1.13971464
[22,]  1.1212586  2.4841127  0.7569769  0.97103984  0.1235016 -1.0539744 -1.86898584 -2.5572863 -2.1185176 -0.91569904
[23,] -1.4640457 -3.0939898 -0.7815536  0.45404610 -1.5803221  0.5294487 -0.80398724 -0.6295771 -0.6401513 -0.33188900
[24,] -1.2062359 -0.5763684 -0.2660264  0.84166327  0.4226794 -0.7408412 -1.20247361 -0.4014731  0.7498091  0.00734897
[25,]  2.5452617  1.1454221  0.1633542 -1.11772677  0.3137463  0.2120594  0.03715160 -1.8153420 -1.0119681  0.04705111
[26,]  1.1280855  3.6129255  0.6771863  0.85117743  1.6380531 -0.5936850 -0.16836271 -0.3994108 -1.4245067 -0.68459132
            [,20]       [,21]
 [1,]  0.33025321  1.62776428
 [2,] -2.55574379 -2.16635489
 [3,]  0.36577388  1.09321509
 [4,]  1.74241969  0.83462669
 [5,] -0.02097675  0.40723480
 [6,]  0.93263338 -0.80652982
 [7,] -2.07152992 -2.76863192
 [8,]  1.17006140  3.37783116
 [9,] -1.43035389 -0.02110374
[10,]  0.68819931  1.91945327
[11,] -0.43519164 -0.33307616
[12,]  0.19709895 -1.17341262
[13,]  2.22818290  1.08010456
[14,] -4.32802529 -2.81551880
[15,] -1.78708342 -1.97023751
[16,] -1.84771446 -1.08489335
[17,]  1.79520247  1.18117832
[18,] -1.19718523 -1.08586473
[19,]  0.77756815  0.46337202
[20,]  1.10998001 -0.61218687
[21,]  2.53066587  0.70726573
[22,] -2.37520373 -4.56247332
[23,]  2.20229378  1.01954574
[24,]  0.57432878 -1.25489999
[25,] -2.88271387 -1.22923444
[26,] -0.16875752 -3.04923912
```
### Coverage
``` r
fit.pooled.method$coverage

[1] 0.52
```
    
------------------------------------------------------------------------

# Jackknife Method

``` r
# Target subject: subject 1
fit.jackknife.method <- Jackknife.fun.calib(x=Yij.todos[[1]],
                                            mesh=tm, dimension.Bspline=20,
                                            q=2, alpha=0.5)

# Generation of 50 new curves for subject 1
s <- 1
sigma <- 1
Nt <- 21
curves.per.patient <- 50
fixed.subject.effect <- rep(0,Nt)
visit.effect <- matrix(0, nrow=curves.per.patient, ncol=Nt)
Yij <- matrix(0, nrow=curves.per.patient, ncol=Nt)
tm <- (0:20)/100

for(t in 1:Nt){
  for(k in 1:4){
    lambda.k1 <- lambda.k1.values(k)
    set.seed(1234+40+s)
    fixed.xk <- xik.values(lambda.k1)
    fixed.subject.effect[t] <- fixed.subject.effect[t] + 
      fixed.xk*phik1.values(tm[t])[[k]]
  }
}

for(j in 1:curves.per.patient){
  for(t in 1:Nt){
    for(l in 1:4){
      lambda.l2 <- lambda.l2.values(l)
      set.seed(1234+s+j)
      zetaijl <- zetaijl.values(lambda.l2)
      visit.effect[j,t] <- visit.effect[j,t] + 
        zetaijl*phil2.values(tm[t])[[l]]
    }
  }
}

for(j in 1:curves.per.patient){
  for(t in 1:Nt){
    Yij[j,t] <- fixed.subject.effect[t] + visit.effect[j,t] +
      rnorm(1,0,sigma)
  }
}
Yij.new.subject.1 <- Yij

pred.jackknife.method <- Jackknife.fun.pred(xnew=Yij.new.subject.1,
                  mesh=tm, dimension.Bspline=20,
                  quantile=fit.jackknife.method$quantile,
                  calib.proj.mu=fit.jackknife.method$calib.proj.mu,
                  calib.proj.B=fit.jackknife.method$calib.proj.B,
                  calib.proj.weights=fit.jackknife.method$calib.proj.weights)
```

## Results

### Quantile

``` r
fit.pooled.method$quantile
      50% 
0.8050928
```
          
### Prediction Region Indices

``` r
fit.pooled.method$predictionRegionIndices

[1]  6 28 35
```
  
Total selected: **3 / 50**

### Prediction Region Curves

``` r
fit.pooled.method$predictionRegionCurves
         [,1]       [,2]        [,3]       [,4]       [,5]       [,6]      [,7]       [,8]       [,9]       [,10]
[1,] 1.148597 -0.2971043  0.03993959 -0.7812286 -0.1528351 -0.8409304 -1.285984 -1.3229714  0.5681100 -1.97640998
[2,] 1.021982  1.0617092 -0.41442062  2.6070953  0.3451367 -1.1245336  2.351890  0.9114444 -0.0317997  0.03486206
[3,] 2.135391  1.9537345  2.46668133  2.5580131  1.0527066  2.4523522  1.473138  0.6169927  2.2095806  1.75677141
          [,11]       [,12]       [,13]      [,14]      [,15]      [,16]      [,17]     [,18]     [,19]      [,20]
[1,] -1.0713272  0.01794047 -1.50089101 -2.1265350  0.8495253  0.8191931 -1.5147578 -2.614563 -2.312054 -2.0909594
[2,]  2.0387595  0.24010105  0.05673557 -0.4971249  0.2952184 -2.6940583 -0.5363041 -1.927467 -2.895365 -0.8737651
[3,]  0.7807956 -0.39407008  2.42097536 -2.7608953 -1.5151779 -1.3630195 -1.7957467 -4.165169 -2.698133 -3.5130493
         [,21]
[1,] -1.538245
[2,] -1.447693
[3,] -5.601028
```

### Coverage

``` r
fit.pooled.method$coverage

[1] 0.06
```
    

------------------------------------------------------------------------

# Reproducibility

To reproduce the full analysis locally:

``` r
source("toy.example.R")
```

This script compiles the C++ code, generates the synthetic data, and
applies the conformal prediction method automatically.

